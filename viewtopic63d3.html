<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr">

<!-- Mirrored from localhost/phpbb2/viewtopic.php?t=1822&start=0&postdays=0&postorder=asc&highlight= by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Mar 2018 20:55:27 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="Content-Style-Type" content="text/css">

<link rel="top" href="index-2.html" title="VB Decompiler Forum Index" />
<link rel="search" href="search.html" title="Search" />
<link rel="help" href="faq.html" title="FAQ" />
<link rel="author" href="memberlist.html" title="Memberlist" />
<link rel="prev" href="viewtopic76f7.html" xx="t=1822&amp;view=previous" title="View previous topic" />
<link rel="next" href="viewtopic695a.html" xx="t=1822&amp;view=next" title="View next topic" />
<link rel="up" href="viewforum8941.html" xx="f=22" title="Articles" />

<title>VB Decompiler :: View topic - VB: Wearing the Inside Out</title>
<!-- link rel="stylesheet" href="templates/subSilver/subSilver.css" type="text/css" -->
<style type="text/css">
<!--
/*
  The original subSilver Theme for phpBB version 2+
  Created by subBlue design
  http://www.subBlue.com

  NOTE: These CSS definitions are stored within the main page body so that you can use the phpBB2
  theme administration centre. When you have finalised your style you could cut the final CSS code
  and place it in an external file, deleting this section to save bandwidth.
*/

/* General page style. The scroll bar colours only visible in IE5.5+ */
body {
	background-color: #E5E5E5;
	scrollbar-face-color: #DEE3E7;
	scrollbar-highlight-color: #FFFFFF;
	scrollbar-shadow-color: #DEE3E7;
	scrollbar-3dlight-color: #D1D7DC;
	scrollbar-arrow-color:  #006699;
	scrollbar-track-color: #EFEFEF;
	scrollbar-darkshadow-color: #98AAB1;
}

/* General font families for common tags */
font,th,td,p { font-family: Verdana, Arial, Helvetica, sans-serif }
a:link,a:active,a:visited { color : #006699; }
a:hover		{ text-decoration: underline; color : #DD6900; }
hr	{ height: 0px; border: solid #D1D7DC 0px; border-top-width: 1px;}

/* This is the border line & background colour round the entire page */
.bodyline	{ background-color: #FFFFFF; border: 1px #98AAB1 solid; }

/* This is the outline round the main forum tables */
.forumline	{ background-color: #FFFFFF; border: 2px #006699 solid; }

/* Main table cell colours and backgrounds */
td.row1	{ background-color: #EFEFEF; }
td.row2	{ background-color: #DEE3E7; }
td.row3	{ background-color: #D1D7DC; }

/*
  This is for the table cell above the Topics, Post & Last posts on the index.php page
  By default this is the fading out gradiated silver background.
  However, you could replace this with a bitmap specific for each forum
*/
td.rowpic {
		background-color: #FFFFFF;
		background-image: url(templates/subSilver/images/cellpic2.jpg);
		background-repeat: repeat-y;
}

/* Header cells - the blue and silver gradient backgrounds */
th	{
	color: #FFA34F; font-size: 11px; font-weight : bold;
	background-color: #006699; height: 25px;
	background-image: url(templates/subSilver/images/cellpic3.gif);
}

td.cat,td.catHead,td.catSides,td.catLeft,td.catRight,td.catBottom {
			background-image: url(templates/subSilver/images/cellpic1.gif);
			background-color:#D1D7DC; border: #FFFFFF; border-style: solid; height: 28px;
}

/*
  Setting additional nice inner borders for the main table cells.
  The names indicate which sides the border will be on.
  Don't worry if you don't understand this, just ignore it :-)
*/
td.cat,td.catHead,td.catBottom {
	height: 29px;
	border-width: 0px 0px 0px 0px;
}
th.thHead,th.thSides,th.thTop,th.thLeft,th.thRight,th.thBottom,th.thCornerL,th.thCornerR {
	font-weight: bold; border: #FFFFFF; border-style: solid; height: 28px;
}
td.row3Right,td.spaceRow {
	background-color: #D1D7DC; border: #FFFFFF; border-style: solid;
}

th.thHead,td.catHead { font-size: 12px; border-width: 1px 1px 0px 1px; }
th.thSides,td.catSides,td.spaceRow	 { border-width: 0px 1px 0px 1px; }
th.thRight,td.catRight,td.row3Right	 { border-width: 0px 1px 0px 0px; }
th.thLeft,td.catLeft	  { border-width: 0px 0px 0px 1px; }
th.thBottom,td.catBottom  { border-width: 0px 1px 1px 1px; }
th.thTop	 { border-width: 1px 0px 0px 0px; }
th.thCornerL { border-width: 1px 0px 0px 1px; }
th.thCornerR { border-width: 1px 1px 0px 0px; }

/* The largest text used in the index page title and toptic title etc. */
.maintitle	{
	font-weight: bold; font-size: 22px; font-family: "Trebuchet MS",Verdana, Arial, Helvetica, sans-serif;
	text-decoration: none; line-height : 120%; color : #000000;
}

/* General text */
.gen { font-size : 12px; }
.genmed { font-size : 11px; }
.gensmall { font-size : 10px; }
.gen,.genmed,.gensmall { color : #000000; }
a.gen,a.genmed,a.gensmall { color: #006699; text-decoration: none; }
a.gen:hover,a.genmed:hover,a.gensmall:hover	{ color: #DD6900; text-decoration: underline; }

/* The register, login, search etc links at the top of the page */
.mainmenu		{ font-size : 11px; color : #000000 }
a.mainmenu		{ text-decoration: none; color : #006699;  }
a.mainmenu:hover{ text-decoration: underline; color : #DD6900; }

/* Forum category titles */
.cattitle		{ font-weight: bold; font-size: 12px ; letter-spacing: 1px; color : #006699}
a.cattitle		{ text-decoration: none; color : #006699; }
a.cattitle:hover{ text-decoration: underline; }

/* Forum title: Text and link to the forums used in: index.php */
.forumlink		{ font-weight: bold; font-size: 12px; color : #006699; }
a.forumlink 	{ text-decoration: none; color : #006699; }
a.forumlink:hover{ text-decoration: underline; color : #DD6900; }

/* Used for the navigation text, (Page 1,2,3 etc) and the navigation bar when in a forum */
.nav			{ font-weight: bold; font-size: 11px; color : #000000;}
a.nav			{ text-decoration: none; color : #006699; }
a.nav:hover		{ text-decoration: underline; }

/* titles for the topics: could specify viewed link colour too */
.topictitle,h1,h2	{ font-weight: bold; font-size: 11px; color : #000000; }
a.topictitle:link   { text-decoration: none; color : #006699; }
a.topictitle:visited { text-decoration: none; color : #5493B4; }
a.topictitle:hover	{ text-decoration: underline; color : #DD6900; }

/* Name of poster in viewmsg.php and viewtopic.php and other places */
.name			{ font-size : 11px; color : #000000;}

/* Location, number of posts, post date etc */
.postdetails		{ font-size : 10px; color : #000000; }

/* The content of the posts (body of text) */
.postbody { font-size : 12px; line-height: 18px}
a.postlink:link	{ text-decoration: none; color : #006699 }
a.postlink:visited { text-decoration: none; color : #5493B4; }
a.postlink:hover { text-decoration: underline; color : #DD6900}

/* Quote & Code blocks */
.code {
	font-family: Courier, 'Courier New', sans-serif; font-size: 11px; color: #006600;
	background-color: #FAFAFA; border: #D1D7DC; border-style: solid;
	border-left-width: 1px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px
}

.quote {
	font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 11px; color: #444444; line-height: 125%;
	background-color: #FAFAFA; border: #D1D7DC; border-style: solid;
	border-left-width: 1px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px
}

/* Copyright and bottom info */
.copyright		{ font-size: 10px; font-family: Verdana, Arial, Helvetica, sans-serif; color: #444444; letter-spacing: -1px;}
a.copyright		{ color: #444444; text-decoration: none;}
a.copyright:hover { color: #000000; text-decoration: underline;}

/* Form elements */
input,textarea, select {
	color : #000000;
	font: normal 11px Verdana, Arial, Helvetica, sans-serif;
	border-color : #000000;
}

/* The text input fields background colour */
input.post, textarea.post, select {
	background-color : #FFFFFF;
}

input { text-indent : 2px; }

/* The buttons used for bbCode styling in message post */
input.button {
	background-color : #EFEFEF;
	color : #000000;
	font-size: 11px; font-family: Verdana, Arial, Helvetica, sans-serif;
}

/* The main submit button option */
input.mainoption {
	background-color : #FAFAFA;
	font-weight : bold;
}

/* None-bold submit button */
input.liteoption {
	background-color : #FAFAFA;
	font-weight : normal;
}

/* This is the line in the posting page which shows the rollover
  help line. This is actually a text box, but if set to be the same
  colour as the background no one will know ;)
*/
.helpline { background-color: #DEE3E7; border-style: none; }

/* Import the fancy styles for IE only (NS4.x doesn't use the @import function) */
@import url("templates/subSilver/formIE.css");
-->
</style>
</head>
<body bgcolor="#E5E5E5" text="#000000" link="#006699" vlink="#5493B4">

<a name="top"></a>

<table width="100%" cellspacing="0" cellpadding="10" border="0" align="center">
	<tr>
		<td class="bodyline"><table width="100%" cellspacing="0" cellpadding="0" border="0">
			<tr>
				<td><a href="index-2.html"><img src="templates/subSilver/images/logo_phpBB.gif" border="0" alt="VB Decompiler Forum Index" vspace="1" /></a></td>
				<td align="center" width="100%" valign="middle"><span class="maintitle">VB Decompiler</span><br /><span class="gen">Hosted by TheAutomaters.com<br />&nbsp; </span>
				<table cellspacing="0" cellpadding="2" border="0">
					<tr>
						<td align="center" valign="top" nowrap="nowrap"><span class="mainmenu">&nbsp;
						<a href="memberlist.html" class="mainmenu"><img src="templates/subSilver/images/icon_mini_members.gif" width="12" height="13" border="0" alt="Memberlist" hspace="3" />Memberlist</a>
						</span></td>
					</tr>
					<tr>
						<td height="25" align="center" valign="top" nowrap="nowrap"><span class="mainmenu">&nbsp;</td>
					</tr>
				</table></td>
			</tr>
		</table>

		<br />


<table width="100%" cellspacing="2" cellpadding="2" border="0">
  <tr>
	<td align="left" valign="bottom" colspan="2"><a class="maintitle" href="viewtopic63d3.html" xx="t=1822&amp;start=0&amp;postdays=0&amp;postorder=asc&amp;highlight=">VB: Wearing the Inside Out</a><br />
	  <span class="gensmall"><b></b><br />
	  &nbsp; </span></td>
  </tr>
</table>

<table width="100%" cellspacing="2" cellpadding="2" border="0">
  <tr>
	<td></td>
	<td align="left" valign="middle" width="100%"><span class="nav">&nbsp;&nbsp;&nbsp;<a href="index-2.html" class="nav">VB Decompiler Forum Index</a>
	  -> <a href="viewforum8941.html" xx="f=22" class="nav">Articles</a></span></td>
  </tr>
</table>

<table class="forumline" width="100%" cellspacing="1" cellpadding="3" border="0">
	<tr>
		<th class="thLeft" width="150" height="26" nowrap="nowrap">Author</th>
		<th class="thRight" nowrap="nowrap">Message</th>
	</tr>
	<tr>
		<td width="150" align="left" valign="top" class="row1"><span class="name"><a name="2761"></a><b>_aLfa_</b></span><br /><span class="postdetails">Site Admin<br /><!--<img src="pro_rank_admin.gif" alt="Site Admin" title="Site Admin" border="0" /><br />--><br /><br />Joined: 21 Sep 2002<br />Posts: 233<br />Location: Aveiro, Portugal</span><br /></td>
		<td class="row1" width="100%" height="28" valign="top">
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td width="100%">
						<span class="postdetails">
							Posted: Wed Sep 08, 2004 11:26 am
							<span class="gen">&nbsp;</span>&nbsp; &nbsp;Post subject: VB: Wearing the Inside Out
						</span>
					</td>
				</tr>
				<tr>
					<td colspan="2"><hr /></td>
				</tr>
				<tr>
					<td colspan="2">
						<span class="postbody"><span style="color: #808080"><span style="font-style: italic">Richard Marko
<br />
ESET Software, Slovakia</span></span>
<br />

<br />
With a user base of around five million, Visual Basic (VB) is probably the most widely used programming language in the world. Though not very suitable for 'hard-core' professionals, VB makes programming very simple and this is why it is so popular with beginners. Not surprisingly, we see a lot of worms, backdoors and other kinds of malware written in Visual Basic.
<br />

<br />
VB versions 5.0 and 6.0 are able to create two types of executable: P-Code and native code (both require VB runtime DLL to execute). The majority of projects written in VB (including malware) are compiled to native code simply because it is the default option. However, it is very simple to change it to P-Code, so there is good reason to study the internals of such executables. Understanding pcode will also help us to gain a better understanding of native code.
<br />

<br />
An article by Andy Nikishin and Mike Pavlyushchik, in the January 2002 issue of <a href="http://www.virusbtn.com/"><span style="font-style: italic">Virus Bulletin</span></a>  (<a href="viewtopic4ad4.html" xx="p=2760#2760">see <span style="font-style: italic">VB</span>, January 2002, p.6</a> ) presents a good introduction to the internal structures of VB executables, especially those compiled to native code. In this article, executables compiled to P-Code will be examined more closely.
<br />

<br />

<br />
<span style="font-weight: bold">P-Code Basics</span>
<br />
P-Code, or <span style="font-style: italic">pseudo code</span>, is a set of stack-oriented CPU-independent instructions, an intermediate step between the high-level statements in Basic program and the low-level native code instructions executed by a computer's processor. It can be interpreted either by VB virtual machine (in case the project is compiled to P-Code) or converted to a native code and optimized (in case the project is compiled to native code). It has instructions for loading, storing, initializing, object method calling, many instructions for arithmetic and logical operations, control flow and so on.
<br />

<br />
To avoid any misunderstandings in terminology, it should be noted that the P-Code generated by Visual Basic for Application (VBA) differs from that generated by VB. While the P-Code of VBA is basically the pre-processed source code stored in a special ready-to-interpret form, P-Code of VB is a result of true compilation. It is, therefore, comparable to MSIL (Microsoft Intermediate Language) used by <span style="font-style: italic">Microsoft's .NET Framework</span>.
<br />

<br />

<br />
<span style="font-weight: bold">P-Code Internals</span>
<br />
The internal structures of VB executables are not documented. Fortunately, however, debug information for VB runtime DLL is available. This way we can learn the names of P-Code instructions and, generally, it makes the analysis easier.
<br />

<br />
To see how things really work we will first examine a simple 'Hello World!' project with one module and the following source code:
<br />

<br />
[vb]Sub Main()  MsgBox &quot;Hello World!&quot;End Sub[/vb]
<br />

<br />
We set 'Compile to P-Code' in project properties and compile it. After the PE executable is built we find a wellknown stub at the entry point:
<br />

<br />
[asm]00401038 push offset EXEPROJECTINFO0040103D call MSVBVM60:ThunRTMain[/asm]
<br />

<br />
The ThunRTMain function exported by VB runtime DLL reads the EXEPROJECTINFO structure and starts VB project initialization. The structure contains a lot of important information, such as the address of the Main() function. The VB runtime will eventually call this address (if it is defined). Examining the code there we see:
<br />

<br />
[asm]004011CC  mov   edx,00040175C004011D1  mov   ecx,000401032004011D6  jmp   ecx...00401032  jmp   MSVBVM60:ProcCallEngine[/asm]
<br />

<br />
The code loads the address of a structure to edx and calls the P-Code interpretation engine (ProcCallEngine) in the VB runtime library. The structure in edx (let us call it ProcDescription) contains all the important information about the Main() function, including the address of the corresponding module description structure, the size of local variables and the size of all P-Code instructions for this function.
<br />

<br />
The ProcCallEngine loads various internal data, sets the error handler, allocates sufficient space on the stack and then starts processing the P-Code instructions:
<br />

<br />
[asm]ProcCallEngine:...66104abe  mov   ebx,edx...66104b7f  movzx esi,word ptr [ebx+08] ; P-Code size66104b83  neg   esi66104b85  add   esi,ebx...66104b8d  xor   eax,eax66104b8f  mov   al,[esi]66104b91  inc   esi66104b92  jmp   dword ptr [tblDispatch+eax*4][/asm]
<br />

<br />
From the code above we see the P-Code instructions precede the ProcDescription structure directly. The first byte of every instruction encodes the instruction type. This leads to 256 different encodings, though not all of these are used. Furthermore, opcodes 0xfb - 0xff, named Lead0 - Lead4, have a second opcode byte and thus constitute a new set of 256 encodings each. Consequently, there are hundreds of different P-Code instructions. The opcode bytes may be followed by one or more arguments. The majority of the instructions have a fixed number of arguments but there are a few exceptions.
<br />

<br />
Knowing all that, we can inspect the P-Code for our example Main() function itself:
<br />

<br />
</span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr> 	  <td><span class="genmed"><b>Code:</b></span></td>	</tr>	<tr>	  <td class="code">0000 27FCFE      LitVar_Missing  loc_0104 ; Context
<br />
0003 271CFF      LitVar_Missing  loc_00E4 ; HelpFile
<br />
0006 273CFF      LitVar_Missing  loc_00C4 ; Title
<br />
0009 F500000000  LitI4           00000000 ; Buttons
<br />
000E 3A6CFF0000  LitVarStr       loc_0094,                                 &quot;Hello World!&quot;
<br />
0013 4E5CFF      FStVarCopyObj   loc_00A4
<br />
0016 045CFF      FLdRfVar        loc_00A4 ; Prompt
<br />
0019 0A01001400  ImpAdCallFPR4   rtcMsgBox,14
<br />
001E 3608005CFF3CFF1C  FFreeVar             loc_00A4,loc_00C4,loc_00E4,loc_0104
<br />
0029 14          ExitProc
<br />
</td>	</tr></table><span class="postbody">
<br />

<br />
Let us explain this code briefly. We already mentioned that the VB P-Code instructions are stack-oriented. The operation of an instruction can be derived from its name, but often it is necessary to inspect the actual code in the runtime DLL that interprets it.
<br />

<br />
The name of the first instruction, LitVar_Missing, can be divided into three parts. 'Lit' states that a value will be pushed onto the top of the stack. 'Var', which stands for 'Variant', not 'variable', tells us that the instruction works with a variable of the 'Variant' type (Variant is a special data type that can contain any standard kind of data). Finally, 'Missing' specifies that the variable will be loaded with a special DISP_E_PARAMNOTFOUND value.
<br />

<br />
The instruction takes one argument which is the offset of a local variable from the top of the stack. It fills it with the value and pushes its address onto the stack (the Variant type occupies more than four bytes in memory and therefore is not pushed directly onto the stack; instead a reference to it is added). LitI4 takes the I4 (Long) argument and, as expected, pushes it onto the stack also.
<br />

<br />
The second argument of the LitVarStr instruction is an index to a special table (ReferenceTable) which contains the addresses of various data such as strings, imported functions, COM objects and so on.
<br />

<br />
Every module in VB project has its own ReferenceTable. In the case of LitVarStr the corresponding address in this table points to a string in BSTR format (Unicode zero-terminated string preceded by its length). The string is contained in the read-only '.text' section of the PE executable, so a copy of it is created first by FStVarCopyObj. A reference to the copy is then pushed onto the stack by the FLdRfVar instruction as the first (Prompt) parameter of the MsgBox() function. We did not specify the remaining four parameters (Buttons, Title, HelpFile and Context), so they were generated automatically. The last three are loaded by LitVar_Missing and the Buttons parameter is vbOKOnly (defined as 0) by default.
<br />

<br />
The ImpAdCallFPR4 instruction takes two arguments. The first is an index to ReferenceTable, the second is the size of parameters on stack. The instruction takes an address from ReferenceTable and sends a call there. The code at this address follows:
<br />

<br />
[asm]00401020  jmp   MSVBVM60:rtcMsgBox[/asm]
<br />
As can be seen, the code simply jumps to the routine statically imported from VB virtual machine DLL. After rtcMsgBox returns, the FFreeVar instruction checks all the Variant variables used and frees any allocated resources (in our example the copy of the 'Hello World!' string). Finally, ExitProc does all the necessary de-initializations, removes the error handler, restores the stack (removes all possible arguments) and returns to the caller of ProcCallEngine.
<br />

<br />
The example above has shown that, from the VB runtime point of view, there is not a big difference between a project compiled to native code and P-Code. It can call P-Code functions just like native code and the small chunks of code do all the necessary work to ensure the P-Code will be interpreted correctly.
<br />

<br />
This example was very simple. Most VB projects have no Main() function; instead they have a starting form. Finding the entry points of the starting form events (for example 'Load()') is more complicated and requires knowledge of several data structures which can be traced from the EXEPROJECTINFO structure.
<br />

<br />

<br />
<span style="font-weight: bold">Imported Functions</span>
<br />
Applications written in VB are able to call external procedures in DLLs. These can be imported either statically (during load time via the PE import section) or dynamically (during run time). Usually the procedures of the VB runtime library are imported statically. This includes procedures like ThunRTMain or ProcCallEngine, which are referenced automatically by VB compiler, as well as a special set of functions available to the VB programmer. They can be used in code without explicit declaration.
<br />

<br />
The names of these functions have the 'rtc' prefix (the prefix is added by the compiler, so it does not appear in the source code). Some of them are interesting in terms of generic malware detection - rtcCreateObject, rtcFileCopy and so on. The way these functions are called was illustrated in the previous example.
<br />

<br />

<br />
<span style="font-weight: bold">Dynamic Imports</span>
<br />
Of more interest are calls to external API functions declared using the 'Declare' statement. The information about such functions is stored in a special table (ImportTable). Each entry contains the name of the function and DLL together with a short piece of native code that invokes the function. The following example illustrates the use of external functions. A similar code can be found in many backdoors: 
<br />

<br />
[vb]Public Declare Function GetCurrentProcessId _  Lib &quot;kernel32&quot; () As LongPublic Declare Function RegisterServiceProcess _  Lib &quot;kernel32&quot; (ByVal dwProcessID As Long, _  ByVal dwType As Long) As Long Public Sub MakeMeService()  Dim pid As Long  Dim regserv As Long   On Error Resume Next  pid = GetCurrentProcessId()  regserv = RegisterServiceProcess(pid, 1)End Sub[/vb]
<br />

<br />
This source code compiles to: 
<br />

<br />
</span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr> 	  <td><span class="genmed"><b>Code:</b></span></td>	</tr>	<tr>	  <td class="code">0000 0002        LargeBos           00020002 0005        LargeBos           00070004 4BFFFF      OnErrorGoto        Resume Next0007 0011        LargeBos           00180009 5E00000000  ImpAdCallI4                   kernel32&#58;GetCurrentProcessId,00000E 7170FF      FStI4              loc_00900011 3C          SetLastSystemError0012 6C70FF      ILdRf              loc_00900015 7178FF      FStI4              loc_00880018 0019        LargeBos           0031001A F501000000  LitI4              00000001001F 6C78FF      ILdRf              loc_00880022 5E01000800  ImpAdCallI4                   kernel32&#58;RegisterServiceProcess,080027 7170FF      FStI4              loc_0090002A 3C          SetLastSystemError002B 6C70FF      ILdRf              loc_0090002E 7174FF      FStI4              loc_008C0031 0000        LargeBos           00310033 14          ExitProc</td>	</tr></table><span class="postbody">
<br />

<br />
Using the 'On Error Resume Next' statement is a little trick. It forces VB compiler to put the LargeBos instruction in front of the compilation of every statement, so we can easily see how a particular statement is compiled.
<br />

<br />
The loc_0088 is the pid variable and loc_008C is regserv. The way both API functions are called is very similar to the way the rtcMsgBox function was called in the previous example (although, now, both functions return Long value so it is reflected in the mnemonic code of the ImpAdCallI4 instruction). However, the associated code (remember its address is in ReferenceTable) is different:
<br />

<br />
[asm]0040134C  mov   eax,[004022E4]00401351  or    eax,eax00401353  je    0040135700401355  jmp   eax00401357  push  004013340040135C  mov   eax,0040102000401361  call  eax00401363  jmp   eax...00401020  jmp   MSVBVM60:DllFunctionCall[/asm]
<br />

<br />
First the code checks whether the address of the imported function has been located already. If it has, it simply jumps there, otherwise the DllFunctionCall function is invoked with a pointer to the entry of ImportTable as an argument. DllFunctionCall reads the name of the imported function and DLL from there and tries to get the address using LoadLibraryA and GetProcAddress API. If successful it will save this address (to variable at 4022E4 in this case) and return it. If not, it invokes the error handler internally.
<br />

<br />

<br />
<span style="font-weight: bold">COM Technology</span>
<br />
One of the reasons why VB is so popular must be the fact that it makes programming with COM objects so simple. Often a program that would take a lot of coding (and perhaps cause a lot of headaches) in languages like C++ can be written in a few lines of VB. Of course we pay a price for the comfort but sometimes it is very elegant.
<br />

<br />
In contrast to the VBA or VBScript members of the Visual Basic family, VB supports late binding as well as both types of early binding - vtable and DispID bindings.
<br />

<br />

<br />
<span style="font-weight: bold">Late Binding</span>
<br />
While there is usually no need to use pricey late binding in VB, source codes of the infamous Melissa (VBA) and LoveLetter (VBScript) worms are so popular that the majority of VB email worms we see use this kind of binding. It means that no type library information about the COM object used is available during compilation so this must be collected during run time.
<br />

<br />
The example will show the way a few lines of code in VB are compiled to P-Code. They use MS Outlook COM object to create an email. As we have selected no additional references in the VB project settings, nor have we explicitly defined the type of object variables, the compiler has no other option than to use the late binding. The source code:
<br />

<br />
[vb]...Set out = CreateObject(&quot;Outlook.Application&quot;)Set mail = out.CreateItem(0)mail.Recipients.Add &quot;marko@eset.sk&quot;...[/vb]
<br />

<br />
The corresponding P-Code:
<br />

<br />
</span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr> 	  <td><span class="genmed"><b>Code:</b></span></td>	</tr>	<tr>	  <td class="code">&#46;&#46;&#46;0007 001A         LargeBos       00210009 F500000000   LitI4          00000000000E 1B0000       LitStr         &quot;Outlook&#46;Application&quot;0011 046CFF       FLdRfVar       loc_00940014 0A01000C00   ImpAdCallFPR4  rtcCreateObject2,0C0019 046CFF       FLdRfVar       loc_0094001C 045CFF       FLdRfVar       loc_00A4001F FE4E         SetVarVarFunc0021 0018         LargeBos       00390023 284CFF0000   LitVarI2       loc_00B4,00000028 25           PopAdLdVar0029 045CFF       FLdRfVar       loc_00A4002C FF426CFF02000100 VarLateMemCallLdVar                                 loc_0094,CreateItem,10034 042CFF       FLdRfVar       loc_00D40037 FE4E         SetVarVarFunc0039 001C         LargeBos       0055003B 3A4CFF0300   LitVarStr      loc_00B4,&quot;marko@eset&#46;sk&quot;0040 25           PopAdLdVar0041 042CFF       FLdRfVar       loc_00D40044 FF3D1CFF0400 VarLateMemLdRfVar                                 loc_00E4,Recipients004A FD9F         LdPrVar004C FE9805000100 LateMemCall    Add,10052 351CFF       FFree1Var      loc_00E4&#46;&#46;&#46;</td>	</tr></table><span class="postbody">
<br />

<br />
All the communication with the COM object is realized via the IDispatch interface. The rtcCreateObject2 function converts input ProgID to CLSID, creates an instance of the specified class and requests a pointer to the IDispatch interface.
<br />

<br />
The methods and properties of this interface are then invoked by 'LateMem' instructions (i.e. their names contain the 'LateMem' string). All take a method/property name as an argument, convert it internally to DispID using IDispatch::GetIDsOfNames and then invoke the method/ property using IDispatch::Invoke.
<br />

<br />
There are several 'LateMem' instructions. Methods are invoked by the 'LateMemCall' instructions, 'LateMemLd' instructions read properties and 'LateMemSt' write properties. If the instruction name is preceded by 'Var', the instruction takes the pointer to the class instance from the reference at the top of the stack. Otherwise, the pointer is read from a special internal variable set by the LdPrVar instruction (actually there are more 'Pr' instructions). On the other hand, if 'Var' is appended to the name, the instruction stores a result value in the specified variable. The 'LateMemCall' instructions also receive the number of arguments for the invoked method while the arguments themselves are prepared on the stack (PopAdLdVar).
<br />

<br />

<br />
<span style="font-weight: bold">VTable Binding</span>
<br />
In the fastest form of early binding, vtable binding, Visual Basic uses an offset into a virtual function table (vtable). It needs to know the layout of vtable, IIDs of interfaces used etc., so appropriate references need to be selected in the project properties. The following code can be found in many worms, backdoors and other malware:
<br />

<br />
[vb]PathName = App.Path &amp; &quot;&quot; &amp; App.EXEName &amp; &quot;.exe&quot;[/vb]
<br />

<br />
While the source code is pretty simple, the compiled code is a little more complicated and lengthy:
<br />

<br />
</span><table width="90%" cellspacing="1" cellpadding="3" border="0" align="center"><tr> 	  <td><span class="genmed"><b>Code:</b></span></td>	</tr>	<tr>	  <td class="code">0000 0474FF      FLdRfVar      loc_008C0003 0478FF      FLdRfVar      loc_00880006 050000      ImpAdLdRf     Global&#58;VBGlobal0009 240100      NewIfNullPr   Global&#58;VBGlobal000C 0D14000200  VCallHresult  VBGlobal&#58;App0011 0878FF      FLdPr         loc_00880014 0D50000300  VCallHresult  _App&#58;Path0019 6C74FF      ILdRf         loc_008C001C 1B0400      LitStr        &quot;&quot;001F 2A          ConcatStr0020 2368FF      FStStrNoPop   loc_00980023 046CFF      FLdRfVar      loc_00940026 0470FF      FLdRfVar      loc_00900029 050000      ImpAdLdRf     Global&#58;VBGlobal002C 240100      NewIfNullPr   Global&#58;VBGlobal002F 0D14000200  VCallHresult  VBGlobal&#58;App0034 0870FF      FLdPr         loc_00900037 0D58000300  VCallHresult  _App&#58;EXEName003C 6C6CFF      ILdRf         loc_0094003F 2A          ConcatStr0040 2364FF      FStStrNoPop   loc_009C0043 1B0500      LitStr        &quot;&#46;exe&quot;0046 2A          ConcatStr0047 4644FF      CVarStr004A FCF654FF    FStVar&#46;&#46;&#46;</td>	</tr></table><span class="postbody">
<br />

<br />
In vtable binding methods and properties are invoked by the 'VCall' instructions. All these instructions take an offset to vtable as the first argument. They take the pointer to the class instance from the internal variable (see previous section) and invoke a method/property at the specified offset in vtable.
<br />

<br />
Since the return value is usually HRESULT the VCallHresult instruction is used most often. This is lucky indeed because this particular instruction takes a second argument. It is an index to ReferenceTable and points to the corresponding interface IID. The instruction verifies the returned HRESULT status internally and if it fails it invokes an error handler. The IID is supplied as an argument to the error handler. With both the vtable offset and the interface IID, it is relatively easy to look up a method/property name.
<br />

<br />

<br />
<span style="font-weight: bold">DispID Binding</span>
<br />
The slower form of early binding is more similar to late binding and is seldom used in VB applications. The Automation COM components usually support dual interfaces (i.e. support both vtable and DispID binding), and VB compiler uses vtable binding whenever possible. There is a set of the 'LateId' instructions which are analogous to the 'LateMem' instructions, but they take the DispID argument instead of method/property name. There is probably no easy way to force VB to use DispID binding, but it is possible. For example, we modified the MS Outlook type library where we changed some of the dual interfaces to pure dispinterfaces. However, since this is clearly a 'laboratory' result we will not discuss it here.
<br />

<br />

<br />
<span style="font-weight: bold">Conclusion</span>
<br />
The study of the internals of Visual Basic executables is a rather complex issue. It is also a time-consuming endeavour, since the analysis requires extensive work with debuggers, disassemblers, hex browsers and similar tools. Visual Basic, being one of the most popular programming languages in the world, may well justify all the effort. The outline of our approach indicates that time-consuming and detailed analysis may, in fact, provide important clues to the VB application's interaction with the outside environment and prove to be instrumental in the development of efficient heuristic rules to identify malicious software generically. The future will show how successful we will be.
<br />

<br />

<br />
<span style="font-weight: bold">Date:</span> June 2002
<br />
<span style="font-weight: bold">Source:</span> <a href="http://www.virusbtn.com/">Virus Bulletin</a> </span>
						<span class="gensmall"></span>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td class="row1" width="150" align="left" valign="middle"><span class="nav"><a href="#top" class="nav">Back to top</a></span></td>
		<td class="row1" width="100%" height="28" valign="bottom" nowrap="nowrap"></td>
	</tr>
	<tr>
		<td class="spaceRow" colspan="2" height="1"><img src="templates/subSilver/images/spacer.gif" alt="" width="1" height="1" /></td>
		<td></td>
	</tr>
	<tr align="center">
		<td class="catBottom" colspan="2" height="28"></td>
		<td></td>
	</tr>
</table>

<table width="100%" cellspacing="2" cellpadding="2" border="0" align="center">
  <tr>
	<td></td>
	<td align="left" valign="middle" width="100%"><span class="nav">&nbsp;&nbsp;&nbsp;<a href="index-2.html" class="nav">VB Decompiler Forum Index</a>
	  -> <a href="viewforum8941.html" xx="f=22" class="nav">Articles</a></span></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">All times are GMT</span><br /><span class="nav"></span>
	  </td>
  </tr>
  <tr>
	<td align="left" colspan="3"><span class="nav">Page <b>1</b> of <b>1</b></span></td>
  </tr>
</table>

<table width="100%" cellspacing="2" border="0" align="center">
  <tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"><span class="gensmall"></span><br />
	  &nbsp;<br />
	  </td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <b>can</b> post new topics in this forum<br />You <b>can</b> reply to topics in this forum<br />You <b>can</b> edit your posts in this forum<br />You <b>can</b> delete your posts in this forum<br />You <b>can</b> vote in polls in this forum<br /></span></td>
  </tr>
</table>


<div align="center"><span class="copyright"><br /><br />
<!--
	We request you retain the full copyright notice below including the link to www.phpbb.com.
	This not only gives respect to the large amount of time given freely by the developers
	but also helps build interest, traffic and use of phpBB 2.0. If you cannot (for good
	reason) retain the full copyright we request you at least leave in place the
	Powered by phpBB line, with phpBB linked to www.phpbb.com. If you refuse
	to include even this then support on our forums may be affected.

	The phpBB Group : 2002
// -->
Powered by <a href="http://www.phpbb.com/" target="_phpbb" class="copyright">phpBB</a> &copy; 2001, 2005 phpBB Group<br /></span></div>
		</td>
	</tr>
</table>

</body>

<!-- Mirrored from localhost/phpbb2/viewtopic.php?t=1822&start=0&postdays=0&postorder=asc&highlight= by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Mar 2018 20:55:27 GMT -->
</html>

