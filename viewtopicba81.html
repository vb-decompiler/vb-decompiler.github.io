<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html dir="ltr">

<!-- Mirrored from localhost/phpbb2/viewtopic.php?t=1821&start=0&postdays=0&postorder=asc&highlight= by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Mar 2018 20:55:27 GMT -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta http-equiv="Content-Style-Type" content="text/css">

<link rel="top" href="index-2.html" title="VB Decompiler Forum Index" />
<link rel="search" href="search.html" title="Search" />
<link rel="help" href="faq.html" title="FAQ" />
<link rel="author" href="memberlist.html" title="Memberlist" />
<link rel="prev" href="viewtopic37ae.html" xx="t=1821&amp;view=previous" title="View previous topic" />
<link rel="next" href="viewtopic8b7f.html" xx="t=1821&amp;view=next" title="View next topic" />
<link rel="up" href="viewforum8941.html" xx="f=22" title="Articles" />

<title>VB Decompiler :: View topic - Generic Detection for Visual Basic Internet Worms</title>
<!-- link rel="stylesheet" href="templates/subSilver/subSilver.css" type="text/css" -->
<style type="text/css">
<!--
/*
  The original subSilver Theme for phpBB version 2+
  Created by subBlue design
  http://www.subBlue.com

  NOTE: These CSS definitions are stored within the main page body so that you can use the phpBB2
  theme administration centre. When you have finalised your style you could cut the final CSS code
  and place it in an external file, deleting this section to save bandwidth.
*/

/* General page style. The scroll bar colours only visible in IE5.5+ */
body {
	background-color: #E5E5E5;
	scrollbar-face-color: #DEE3E7;
	scrollbar-highlight-color: #FFFFFF;
	scrollbar-shadow-color: #DEE3E7;
	scrollbar-3dlight-color: #D1D7DC;
	scrollbar-arrow-color:  #006699;
	scrollbar-track-color: #EFEFEF;
	scrollbar-darkshadow-color: #98AAB1;
}

/* General font families for common tags */
font,th,td,p { font-family: Verdana, Arial, Helvetica, sans-serif }
a:link,a:active,a:visited { color : #006699; }
a:hover		{ text-decoration: underline; color : #DD6900; }
hr	{ height: 0px; border: solid #D1D7DC 0px; border-top-width: 1px;}

/* This is the border line & background colour round the entire page */
.bodyline	{ background-color: #FFFFFF; border: 1px #98AAB1 solid; }

/* This is the outline round the main forum tables */
.forumline	{ background-color: #FFFFFF; border: 2px #006699 solid; }

/* Main table cell colours and backgrounds */
td.row1	{ background-color: #EFEFEF; }
td.row2	{ background-color: #DEE3E7; }
td.row3	{ background-color: #D1D7DC; }

/*
  This is for the table cell above the Topics, Post & Last posts on the index.php page
  By default this is the fading out gradiated silver background.
  However, you could replace this with a bitmap specific for each forum
*/
td.rowpic {
		background-color: #FFFFFF;
		background-image: url(templates/subSilver/images/cellpic2.jpg);
		background-repeat: repeat-y;
}

/* Header cells - the blue and silver gradient backgrounds */
th	{
	color: #FFA34F; font-size: 11px; font-weight : bold;
	background-color: #006699; height: 25px;
	background-image: url(templates/subSilver/images/cellpic3.gif);
}

td.cat,td.catHead,td.catSides,td.catLeft,td.catRight,td.catBottom {
			background-image: url(templates/subSilver/images/cellpic1.gif);
			background-color:#D1D7DC; border: #FFFFFF; border-style: solid; height: 28px;
}

/*
  Setting additional nice inner borders for the main table cells.
  The names indicate which sides the border will be on.
  Don't worry if you don't understand this, just ignore it :-)
*/
td.cat,td.catHead,td.catBottom {
	height: 29px;
	border-width: 0px 0px 0px 0px;
}
th.thHead,th.thSides,th.thTop,th.thLeft,th.thRight,th.thBottom,th.thCornerL,th.thCornerR {
	font-weight: bold; border: #FFFFFF; border-style: solid; height: 28px;
}
td.row3Right,td.spaceRow {
	background-color: #D1D7DC; border: #FFFFFF; border-style: solid;
}

th.thHead,td.catHead { font-size: 12px; border-width: 1px 1px 0px 1px; }
th.thSides,td.catSides,td.spaceRow	 { border-width: 0px 1px 0px 1px; }
th.thRight,td.catRight,td.row3Right	 { border-width: 0px 1px 0px 0px; }
th.thLeft,td.catLeft	  { border-width: 0px 0px 0px 1px; }
th.thBottom,td.catBottom  { border-width: 0px 1px 1px 1px; }
th.thTop	 { border-width: 1px 0px 0px 0px; }
th.thCornerL { border-width: 1px 0px 0px 1px; }
th.thCornerR { border-width: 1px 1px 0px 0px; }

/* The largest text used in the index page title and toptic title etc. */
.maintitle	{
	font-weight: bold; font-size: 22px; font-family: "Trebuchet MS",Verdana, Arial, Helvetica, sans-serif;
	text-decoration: none; line-height : 120%; color : #000000;
}

/* General text */
.gen { font-size : 12px; }
.genmed { font-size : 11px; }
.gensmall { font-size : 10px; }
.gen,.genmed,.gensmall { color : #000000; }
a.gen,a.genmed,a.gensmall { color: #006699; text-decoration: none; }
a.gen:hover,a.genmed:hover,a.gensmall:hover	{ color: #DD6900; text-decoration: underline; }

/* The register, login, search etc links at the top of the page */
.mainmenu		{ font-size : 11px; color : #000000 }
a.mainmenu		{ text-decoration: none; color : #006699;  }
a.mainmenu:hover{ text-decoration: underline; color : #DD6900; }

/* Forum category titles */
.cattitle		{ font-weight: bold; font-size: 12px ; letter-spacing: 1px; color : #006699}
a.cattitle		{ text-decoration: none; color : #006699; }
a.cattitle:hover{ text-decoration: underline; }

/* Forum title: Text and link to the forums used in: index.php */
.forumlink		{ font-weight: bold; font-size: 12px; color : #006699; }
a.forumlink 	{ text-decoration: none; color : #006699; }
a.forumlink:hover{ text-decoration: underline; color : #DD6900; }

/* Used for the navigation text, (Page 1,2,3 etc) and the navigation bar when in a forum */
.nav			{ font-weight: bold; font-size: 11px; color : #000000;}
a.nav			{ text-decoration: none; color : #006699; }
a.nav:hover		{ text-decoration: underline; }

/* titles for the topics: could specify viewed link colour too */
.topictitle,h1,h2	{ font-weight: bold; font-size: 11px; color : #000000; }
a.topictitle:link   { text-decoration: none; color : #006699; }
a.topictitle:visited { text-decoration: none; color : #5493B4; }
a.topictitle:hover	{ text-decoration: underline; color : #DD6900; }

/* Name of poster in viewmsg.php and viewtopic.php and other places */
.name			{ font-size : 11px; color : #000000;}

/* Location, number of posts, post date etc */
.postdetails		{ font-size : 10px; color : #000000; }

/* The content of the posts (body of text) */
.postbody { font-size : 12px; line-height: 18px}
a.postlink:link	{ text-decoration: none; color : #006699 }
a.postlink:visited { text-decoration: none; color : #5493B4; }
a.postlink:hover { text-decoration: underline; color : #DD6900}

/* Quote & Code blocks */
.code {
	font-family: Courier, 'Courier New', sans-serif; font-size: 11px; color: #006600;
	background-color: #FAFAFA; border: #D1D7DC; border-style: solid;
	border-left-width: 1px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px
}

.quote {
	font-family: Verdana, Arial, Helvetica, sans-serif; font-size: 11px; color: #444444; line-height: 125%;
	background-color: #FAFAFA; border: #D1D7DC; border-style: solid;
	border-left-width: 1px; border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px
}

/* Copyright and bottom info */
.copyright		{ font-size: 10px; font-family: Verdana, Arial, Helvetica, sans-serif; color: #444444; letter-spacing: -1px;}
a.copyright		{ color: #444444; text-decoration: none;}
a.copyright:hover { color: #000000; text-decoration: underline;}

/* Form elements */
input,textarea, select {
	color : #000000;
	font: normal 11px Verdana, Arial, Helvetica, sans-serif;
	border-color : #000000;
}

/* The text input fields background colour */
input.post, textarea.post, select {
	background-color : #FFFFFF;
}

input { text-indent : 2px; }

/* The buttons used for bbCode styling in message post */
input.button {
	background-color : #EFEFEF;
	color : #000000;
	font-size: 11px; font-family: Verdana, Arial, Helvetica, sans-serif;
}

/* The main submit button option */
input.mainoption {
	background-color : #FAFAFA;
	font-weight : bold;
}

/* None-bold submit button */
input.liteoption {
	background-color : #FAFAFA;
	font-weight : normal;
}

/* This is the line in the posting page which shows the rollover
  help line. This is actually a text box, but if set to be the same
  colour as the background no one will know ;)
*/
.helpline { background-color: #DEE3E7; border-style: none; }

/* Import the fancy styles for IE only (NS4.x doesn't use the @import function) */
@import url("templates/subSilver/formIE.css");
-->
</style>
</head>
<body bgcolor="#E5E5E5" text="#000000" link="#006699" vlink="#5493B4">

<a name="top"></a>

<table width="100%" cellspacing="0" cellpadding="10" border="0" align="center">
	<tr>
		<td class="bodyline"><table width="100%" cellspacing="0" cellpadding="0" border="0">
			<tr>
				<td><a href="index-2.html"><img src="templates/subSilver/images/logo_phpBB.gif" border="0" alt="VB Decompiler Forum Index" vspace="1" /></a></td>
				<td align="center" width="100%" valign="middle"><span class="maintitle">VB Decompiler</span><br /><span class="gen">Hosted by TheAutomaters.com<br />&nbsp; </span>
				<table cellspacing="0" cellpadding="2" border="0">
					<tr>
						<td align="center" valign="top" nowrap="nowrap"><span class="mainmenu">&nbsp;
						<a href="memberlist.html" class="mainmenu"><img src="templates/subSilver/images/icon_mini_members.gif" width="12" height="13" border="0" alt="Memberlist" hspace="3" />Memberlist</a>
						</span></td>
					</tr>
					<tr>
						<td height="25" align="center" valign="top" nowrap="nowrap"><span class="mainmenu">&nbsp;</td>
					</tr>
				</table></td>
			</tr>
		</table>

		<br />


<table width="100%" cellspacing="2" cellpadding="2" border="0">
  <tr>
	<td align="left" valign="bottom" colspan="2"><a class="maintitle" href="viewtopicba81.html" xx="t=1821&amp;start=0&amp;postdays=0&amp;postorder=asc&amp;highlight=">Generic Detection for Visual Basic Internet Worms</a><br />
	  <span class="gensmall"><b></b><br />
	  &nbsp; </span></td>
  </tr>
</table>

<table width="100%" cellspacing="2" cellpadding="2" border="0">
  <tr>
	<td></td>
	<td align="left" valign="middle" width="100%"><span class="nav">&nbsp;&nbsp;&nbsp;<a href="index-2.html" class="nav">VB Decompiler Forum Index</a>
	  -> <a href="viewforum8941.html" xx="f=22" class="nav">Articles</a></span></td>
  </tr>
</table>

<table class="forumline" width="100%" cellspacing="1" cellpadding="3" border="0">
	<tr>
		<th class="thLeft" width="150" height="26" nowrap="nowrap">Author</th>
		<th class="thRight" nowrap="nowrap">Message</th>
	</tr>
	<tr>
		<td width="150" align="left" valign="top" class="row1"><span class="name"><a name="2760"></a><b>_aLfa_</b></span><br /><span class="postdetails">Site Admin<br /><!--<img src="pro_rank_admin.gif" alt="Site Admin" title="Site Admin" border="0" /><br />--><br /><br />Joined: 21 Sep 2002<br />Posts: 233<br />Location: Aveiro, Portugal</span><br /></td>
		<td class="row1" width="100%" height="28" valign="top">
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td width="100%">
						<span class="postdetails">
							Posted: Wed Sep 08, 2004 1:06 am
							<span class="gen">&nbsp;</span>&nbsp; &nbsp;Post subject: Generic Detection for Visual Basic Internet Worms
						</span>
					</td>
				</tr>
				<tr>
					<td colspan="2"><hr /></td>
				</tr>
				<tr>
					<td colspan="2">
						<span class="postbody"><span style="color: #808080"><span style="font-style: italic">Andy Nikishin and Mike Pavlyushchik
<br />
Kaspersky Lab, Russia</span></span>
<br />

<br />
Recently, we have seen a growing tendency for virus (worm) writers to write their creations using high-level languages such as C++, Pascal (Delphi), Visual Basic and so on. This trend has placed a strong demand on anti-virus experts to find methods of generic detection for such programs using heuristics.
<br />

<br />
It is no secret that Internet worms hold the 'number one spot' in all virus-related charts and lists, and Visual Basic is one of the most popular languages among today's worm writers. For these reasons, we decided to start looking into the possibility of generic detection of Internet worms written in Visual Basic.
<br />

<br />

<br />
<span style="font-weight: bold">Starting Point</span>
<br />
To determine whether or not a program is an Internet worm, we have to analyse the program's behaviour, determine what undesirable things the program does and how it does those things.
<br />

<br />
According to statistics, we know that most of the Internet worms written in Visual Basic (VB) spread using <span style="font-style: italic">MS Outlook</span>. The reason for this is that <span style="font-style: italic">MS Outlook</span> represents a COM object and as such can be accessed by any external program. From another angle, Visual Basic performs these actions 'transparently', meaning that even the program author may know nothing about how it really works.
<br />

<br />

<br />
<span style="font-weight: bold">VB File Format Overview</span>
<br />
There are several versions of <span style="font-style: italic">MS</span> Visual Basic, but we shall examine only versions 5 and 6, since most of the recent Internet worms have been written with these version. The executable file format for the two versions is very similar, so we will analyse them as one. The internal structure of files compiled with <span style="font-style: italic">MS</span> Visual Basic differs from those created by other compilers. The file contains not only program code, but also a lot of data that describes the code and which is used at run time.
<br />

<br />
Usually, anti-virus scanners check program code from the entry point, but in VB files this method is useless. The entry point of a VB file points to a short stub that simply calls a run-time function that never return:
<br />

<br />
[asm:yahelc1a]<div class="asm" id="{CB}" style="font-family: monospace;"><ol><li style="" class="li1">0040273C   <span style="color: #00007f;">push</span>  0004028B4 <span style="color: #adadad; font-style: italic;">; sInitData</span></li><li style="" class="li2"><span style="color: #ff0000;">00402741</span>   <span style="color: #00007f;">call</span>  <span style="color: #ff0000;">000402736</span> <span style="color: #adadad; font-style: italic;">; MSVBVM60.ThunRTMain</span></li><li style="" class="li1"><span style="color: #ff0000;">00402746</span>   <span style="color: #00007f;">add</span>   <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">eax</span><span style="color: #66cc66;">&#93;</span>, <span style="color: #46aa03; font-weight:bold;">al</span></li><li style="" class="li2"><span style="color: #ff0000;">00402748</span>   <span style="color: #00007f;">add</span>   <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">eax</span><span style="color: #66cc66;">&#93;</span>, <span style="color: #46aa03; font-weight:bold;">al</span></li><li style="" class="li1">0040274A   <span style="color: #00007f;">add</span>   <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">eax</span><span style="color: #66cc66;">&#93;</span>, <span style="color: #46aa03; font-weight:bold;">al</span></li></ol></div>[/asm:yahelc1a]
<br />

<br />
Further program execution is under the control of a run-time library that simply calls the program's procedures from file. To prepare the program for running, the run-time library uses data stored in the sInitData structure. Its pointer is passed to the ThunRTMain() run-time function wich initiates the program executions.
<br />

<br />
A great deal of useful information can be obtained by analysing the sInitData structure and its sub-structures. For example, we can find the name of the project and compiled file, all imported and declared functions, used OCX files, begin and end of the native code stream, structures that describe all modules and forms, and so on.
<br />

<br />
<span style="font-style: italic">MS</span> Visual Basic compiler can create two types of executable - 'Native Code', wich contains procedures compiled to native Intel x86 code, and 'P-Code', wich contains the byte code interpreted by the Visual Basic virtual machine at run time. Of course, each code format is reflected in the sInitData structure in a different way, and needs to be processed separately.
<br />

<br />

<br />
<span style="font-weight: bold">Native Code Analysis</span>
<br />
From the sInitData structure we can see that the native code stream or 'segment' lies within the file as a persistent piece. It does not contain statically linked run-time code as, for example, Delphi code does. This means that the stream contains only author-defined code, without any run-time procedures, wich only take up valuable time during analysis. So, the analysis range is limited quite strictly by the code stream.
<br />

<br />
Let's return to Internet worms that use <span style="font-style: italic">MS Outlook</span> to spread. <span style="font-style: italic">MS Outlook</span> represents a COM object with ProgID (OLE Automation programmatic identifier) 'Outlook.Application'. To work with this object the program has to create its instance in some way. For example, it can be done as follows:
<br />

<br />
[vb:yahelc1a]<div class="vb" id="{CB}" style="font-family: monospace;"><ol><li style="" class="li1"><span style="color: #0000ff;">Set</span> objOutlook = <span style="color: #0000ff;">CreateObject</span><span style="color: #000000;">&#40;</span><span style="color: #a31515;">&quot;Outlook.Application&quot;</span><span style="color: #000000;">&#41;</span></li></ol></div>[/vb:yahelc1a]
<br />

<br />
Next, the program uses the object instance by calling its methods and properties. Depending on the definition of the variable that holds the object instance before calling any method or property, Visual Basic performs either early binding (during time of compilation) or late binding (at the run time) automatically.
<br />

<br />

<br />
<span style="font-weight: bold">Late Binding</span>
<br />
Late binding is performed if the type of variable that holds the object instance is defined as Object or Variant: Dim objOutlook as Object or Dim objOutlook as Variant.
<br />

<br />
The VB run-time library has a set of functions for late binding calls. Their names are constructed using 'LateMem' with various prefixes and postfixes: __vba[Var]LateMem[Named][Call][St|Ld][Ad|Rf].
<br />

<br />
For example:
<br />
  __vbaLateMemSt
<br />
  __vbaLateMemCallLd
<br />
  __vbaLateMemNamedStAd
<br />

<br />
We will call these 'LateMem functions'. Each of them receives the name of the calling method (as a string), the number of the method's parameters, the parameters themselvers, and (optionally) a pointer for the result value. For those who are familiar with COM technology basics, we can say that all LateMem functions use IDispatch interface. The LateMem functions transforms the method name to memberId by calling IDispatch::GetIDsOfNames(), then invokes the method with parameters by calling IDispatch::Invoke(). For Example:
<br />

<br />
[vb:yahelc1a]<div class="vb" id="{CB}" style="font-family: monospace;"><ol><li style="" class="li1"><span style="color: #0000ff;">Set</span> objNamespace = objOutlook.<span style="color: #000000;">GetNamespace</span><span style="color: #000000;">&#40;</span><span style="color: #a31515;">&quot;MAPI&quot;</span><span style="color: #000000;">&#41;</span></li></ol></div>[/vb:yahelc1a]
<br />

<br />
The compiled code is as follows:
<br />

<br />
[asm:yahelc1a]<div class="asm" id="{CB}" style="font-family: monospace;"><ol><li style="" class="li1"><span style="color: #ff0000;">00401764</span>   <span style="color: #00007f;">sub</span>   <span style="color: #46aa03; font-weight:bold;">esp</span>, 10h</li><li style="" class="li2"><span style="color: #ff0000;">00401767</span>   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">ecx</span>, <span style="color: #ff0000;">8</span>                <span style="color: #adadad; font-style: italic;">; VT_BSTR</span></li><li style="" class="li1">0040176C   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">edx</span>, <span style="color: #46aa03; font-weight:bold;">esp</span>              <span style="color: #adadad; font-style: italic;">; Param1</span></li><li style="" class="li2">0040176E   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">eax</span>, <span style="color: #0000ff;">offset</span> aMapi     <span style="color: #adadad; font-style: italic;">; &quot;MAPI&quot;</span></li><li style="" class="li1"><span style="color: #ff0000;">00401773</span>   <span style="color: #00007f;">push</span>  <span style="color: #ff0000;">1</span>                     <span style="color: #adadad; font-style: italic;">; params count</span></li><li style="" class="li2"><span style="color: #ff0000;">00401775</span>   <span style="color: #00007f;">push</span>  <span style="color: #0000ff;">offset</span> aGetnamespace  <span style="color: #adadad; font-style: italic;">; &quot;GetNamespace&quot;</span></li><li style="" class="li1">0040177A   <span style="color: #00007f;">mov</span>   <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">edx</span><span style="color: #66cc66;">&#93;</span>, <span style="color: #46aa03; font-weight:bold;">ecx</span></li><li style="" class="li2">           <span style="color: #adadad; font-style: italic;">; Param1.vt=VT_BSTR</span></li><li style="" class="li1">0040177C   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">ecx</span>, <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">ebp</span>+dummy<span style="color: #ff0000;">+4</span><span style="color: #66cc66;">&#93;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401782</span>   <span style="color: #00007f;">mov</span>   <span style="color: #66cc66;">&#91;</span>edx<span style="color: #ff0000;">+4</span><span style="color: #66cc66;">&#93;</span>, <span style="color: #46aa03; font-weight:bold;">ecx</span></li><li style="" class="li1"><span style="color: #ff0000;">00401785</span>   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">ecx</span>, <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">ebp</span>+var_14<span style="color: #66cc66;">&#93;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401788</span>   <span style="color: #00007f;">push</span>  <span style="color: #46aa03; font-weight:bold;">ecx</span></li><li style="" class="li1"><span style="color: #ff0000;">00401789</span>   <span style="color: #00007f;">mov</span>   <span style="color: #66cc66;">&#91;</span>edx<span style="color: #ff0000;">+8</span><span style="color: #66cc66;">&#93;</span>, <span style="color: #46aa03; font-weight:bold;">eax</span></li><li style="" class="li2">           <span style="color: #adadad; font-style: italic;">; Param1.bstrVal=&quot;MAPI&quot;</span></li><li style="" class="li1">0040178C   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">eax</span>, <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">ebp</span>+dummy+<span style="color: #ff0000;">0Ch</span><span style="color: #66cc66;">&#93;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401792</span>   <span style="color: #00007f;">mov</span>   <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">edx</span>+<span style="color: #ff0000;">0Ch</span><span style="color: #66cc66;">&#93;</span>, <span style="color: #46aa03; font-weight:bold;">eax</span></li><li style="" class="li1"><span style="color: #ff0000;">00401795</span>   <span style="color: #00007f;">lea</span>   <span style="color: #46aa03; font-weight:bold;">edx</span>, <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">ebp</span>+objOutlook<span style="color: #66cc66;">&#93;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401798</span>   <span style="color: #00007f;">push</span>  <span style="color: #46aa03; font-weight:bold;">edx</span></li><li style="" class="li1"><span style="color: #ff0000;">00401799</span>   <span style="color: #00007f;">call</span> <span style="color: #46aa03; font-weight:bold;">ds</span>:__vbaLateMemCallLd</li><li style="" class="li2">           <span style="color: #adadad; font-style: italic;">; objOutlook.GetNamespace</span></li></ol></div>[/asm:yahelc1a]
<br />

<br />
As can be seen, before the __vbaLateMemCallLd function is called, the pointer to the object instance (objOutlook), method name (&quot;GetNamespace&quot;) and one parameter (&quot;MAPI&quot;) were place on the stack.
<br />

<br />
Thus, by going through the code and analysing LateMem function calls, we will find all the late binding calls to COM objects.
<br />

<br />

<br />
<span style="font-weight: bold">Early Binding</span>
<br />
Visual Basic performs early binding if the type of variable that holds the object instance is defined as an application defined type:
<br />

<br />
[vb:yahelc1a]<div class="vb" id="{CB}" style="font-family: monospace;"><ol><li style="" class="li1"><span style="color: #0000ff;">Dim</span> objOutlook <span style="color: #0000ff;">As</span> Outlook.<span style="color: #000000;">Application</span></li></ol></div>[/vb:yahelc1a]
<br />

<br />
In this case, the compiled code looks completely diferent. For the same example, the compiled code will be:
<br />

<br />
[asm:yahelc1a]<div class="asm" id="{CB}" style="font-family: monospace;"><ol><li style="" class="li1"><span style="color: #ff0000;">00401794</span>   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">eax</span>, <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">ebp</span>+objOutlook<span style="color: #66cc66;">&#93;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401797</span>   <span style="color: #00007f;">lea</span>   <span style="color: #46aa03; font-weight:bold;">edx</span>, <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">ebp</span>+objNamespace<span style="color: #66cc66;">&#93;</span></li><li style="" class="li1">0040179A   <span style="color: #00007f;">push</span>  <span style="color: #46aa03; font-weight:bold;">edx</span></li><li style="" class="li2">0040179B   <span style="color: #00007f;">push</span>  <span style="color: #0000ff;">offset</span> aMapi          <span style="color: #adadad; font-style: italic;">; &quot;MAPI&quot;</span></li><li style="" class="li1">004017A0   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">ecx</span>, <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">eax</span><span style="color: #66cc66;">&#93;</span></li><li style="" class="li2">004017A2   <span style="color: #00007f;">push</span> <span style="color: #46aa03; font-weight:bold;">eax</span></li><li style="" class="li1">004017A3   <span style="color: #00007f;">call</span> <span style="color: #0000ff;">dword</span> <span style="color: #0000ff;">ptr</span> <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">ecx</span>+4Ch<span style="color: #66cc66;">&#93;</span>    <span style="color: #adadad; font-style: italic;">; GetNamespace</span></li></ol></div>[/asm:yahelc1a]
<br />

<br />
Here the pointer to the method name is not pushed on the stack as a parameter. Instead, the method function is called directly, using the virtual function table (vtable). By analysing this code we can determine wich method has been called, based on the vtable offset (in our example 4Ch), but we need to know the interface type to bind the method number with the exact method name.
<br />

<br />
From the code shown above, we cannot see the interface type, thus it looks as if we have come to a dead end. Fortunately, there is a way out of this situation. If we look at the code just after the method's call, we will see:
<br />

<br />
[asm:yahelc1a]<div class="asm" id="{CB}" style="font-family: monospace;"><ol><li style="" class="li1">004017A6   <span style="color: #00007f;">cmp</span>   <span style="color: #46aa03; font-weight:bold;">eax</span>, <span style="color: #46aa03; font-weight:bold;">esi</span></li><li style="" class="li2">004017A8   <span style="color: #0000ff;">fnclex</span></li><li style="" class="li1">004017AA   <span style="color: #00007f;">jge</span>   <span style="color: #0000ff;">short</span> loc_4017BE</li><li style="" class="li2">004017AC   <span style="color: #00007f;">mov</span>   <span style="color: #46aa03; font-weight:bold;">ecx</span>, <span style="color: #66cc66;">&#91;</span><span style="color: #46aa03; font-weight:bold;">ebp</span>+objOutlook<span style="color: #66cc66;">&#93;</span></li><li style="" class="li1">004017AF   <span style="color: #00007f;">push</span>  4Ch</li><li style="" class="li2">004017B1   <span style="color: #00007f;">push</span>  <span style="color: #0000ff;">offset</span> GUID__Application</li><li style="" class="li1">           <span style="color: #adadad; font-style: italic;">; {00063001-0000-0000-C000-000000000046}</span></li><li style="" class="li2">004017B6   <span style="color: #00007f;">push</span>  <span style="color: #46aa03; font-weight:bold;">ecx</span></li><li style="" class="li1">004017B7   <span style="color: #00007f;">push</span>  <span style="color: #46aa03; font-weight:bold;">eax</span></li><li style="" class="li2">004017B8   <span style="color: #00007f;">call</span> <span style="color: #46aa03; font-weight:bold;">ds</span>:__vbaHresultCheckObj</li><li style="" class="li1">004017BE   ...</li></ol></div>[/asm:yahelc1a]
<br />

<br />
The __vbaHresultCheckObj() function shows an error message if the method called returns an error value. Let us check the input parameters of this function. The third parameter is a reference to the GUID of the interface called (which, in this case, is _Application) and the fourth parameter is offset in the method table (vtable) - in fact, the number of methods multiplied by four (here we have 4Ch; this value corresponded to the GetNamespace method).
<br />

<br />
Tracing the __vbaHresultCheckObj() functions shows us all the program's calls of COM objects using early binding. As a result, we are able to find all the calls of COM objects in a program. Moreover it is unimportant what kind of binding was used - late or early. We filter all calls of interest to an <span style="font-style: italic">MS Outlook</span> object to understand the algorithm's interaction with <span style="font-style: italic">MS Outlook</span>. Finally, using the evidence we have collected, we can pass verdict on the program: guilty or not (i.e. worm or not)!
<br />

<br />

<br />
<span style="font-weight: bold">P-Code Analysis</span>
<br />
During the analysis of P-Code compiled files we find that there is no code executed by CPU (except the entry point). All procedures are compiled into byte code, which is interpreted, controlled and run by Visual Basic's run-time library. Of course, such code needs different data to organize work with objects, local procedures data, constants, and so on. Therefore, the format of sInitData is slightly different.
<br />

<br />
In the process of investigating sInitData and its substructures, we look at the module description tables (in fact, these are descriptions of classes). Among other data there is a table of constants that is used by P-Code. Every module has its own table. These constants are references to strings, GUIDs, declared and run-time functions. Note that these tables are not present in files compiled in native code. Of course, this is understandable - all references to constants are already put into executable code. The following is an example of a constant table:
<br />

<br />
[asm:yahelc1a]<div class="asm" id="{CB}" style="font-family: monospace;"><ol><li style="" class="li1">004017CC  <span style="color: #0000ff;">dd</span>  <span style="color: #0000ff;">offset</span> rtcShell</li><li style="" class="li2">004017D0  <span style="color: #0000ff;">dd</span>  <span style="color: #0000ff;">offset</span> aCProgramFilesN</li><li style="" class="li1">          <span style="color: #adadad; font-style: italic;">; &quot;C:\ProgramFiles\NortonAntiVirus\*.dat&quot;</span></li><li style="" class="li2">004017D4  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aOutlook_applic</li><li style="" class="li1">          <span style="color: #adadad; font-style: italic;">; &quot;Outlook.Application&quot;</span></li><li style="" class="li2">004017D8  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> rtcCreateObject</li><li style="" class="li1">004017DC  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aMapi          <span style="color: #adadad; font-style: italic;">; &quot;MAPI&quot;</span></li><li style="" class="li2">004017E0  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aGetnamespace  <span style="color: #adadad; font-style: italic;">; &quot;GetNameSpace&quot;</span></li><li style="" class="li1">004017E4  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aOutlook       <span style="color: #adadad; font-style: italic;">; &quot;Outlook&quot;</span></li><li style="" class="li2">004017E8  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aGuest         <span style="color: #adadad; font-style: italic;">; &quot;Guest&quot;</span></li><li style="" class="li1">004017EC  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aPassword      <span style="color: #adadad; font-style: italic;">; &quot;password&quot;</span></li><li style="" class="li2">004017F0  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aLogon         <span style="color: #adadad; font-style: italic;">; &quot;Logon&quot;</span></li><li style="" class="li1">004017F4  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aAddresslists  <span style="color: #adadad; font-style: italic;">; &quot;AddressLists&quot;</span></li><li style="" class="li2">004017F8  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aCount         <span style="color: #adadad; font-style: italic;">; &quot;Count&quot;</span></li><li style="" class="li1">004017FC  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aCreateitem    <span style="color: #adadad; font-style: italic;">; &quot;CreateItem&quot;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401800</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aAddressentries</li><li style="" class="li1">          <span style="color: #adadad; font-style: italic;">; &quot;AddressEntries&quot;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401804</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aRecipients    <span style="color: #adadad; font-style: italic;">; &quot;Recipients&quot;</span></li><li style="" class="li1"><span style="color: #ff0000;">00401808</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aAdd           <span style="color: #adadad; font-style: italic;">; &quot;Add&quot;</span></li><li style="" class="li2">0040180C  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aSubject       <span style="color: #adadad; font-style: italic;">; &quot;Subject&quot;</span></li><li style="" class="li1"><span style="color: #ff0000;">00401810</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aBody          <span style="color: #adadad; font-style: italic;">; &quot;Body&quot;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401814</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aAttachments   <span style="color: #adadad; font-style: italic;">; &quot;Attachments&quot;</span></li><li style="" class="li1"><span style="color: #ff0000;">00401818</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aSend          <span style="color: #adadad; font-style: italic;">; &quot;Send&quot;</span></li><li style="" class="li2">0040181C  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> aLogoff        <span style="color: #adadad; font-style: italic;">; &quot;Logoff&quot;</span></li><li style="" class="li1"><span style="color: #ff0000;">00401820</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> a_vxv          <span style="color: #adadad; font-style: italic;">; &quot;.vxv&quot;</span></li><li style="" class="li2"><span style="color: #ff0000;">00401824</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> kernel32_OpenProcess_</li><li style="" class="li1"><span style="color: #ff0000;">00401828</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> kernel32_GetExitCodeProcess_</li><li style="" class="li2">0040182C  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> rtcDoEvents</li><li style="" class="li1"><span style="color: #ff0000;">00401830</span>  <span style="color: #0000ff;">dd</span> <span style="color: #0000ff;">offset</span> rtcGetTimer</li><li style="" class="li2"><span style="color: #ff0000;">00401834</span>  ...</li></ol></div>[/asm:yahelc1a]
<br />

<br />
Here we see that the names of all COM's object methods are present in this table. Even a simple analysis of these strings gives us the opportunity to detect an Internet worm in a program with a high probability. In addition, it is possible to analyse P-Code itself. Such analysis shows us all COM's methods calls as Native code analysis does. However, this variant is more difficult and more laborious and it needs in-depth knowledge of P-Code structure and its additional data, so we shall not examine this method here.
<br />

<br />

<br />
<span style="font-weight: bold">Conclusion</span>
<br />
Usually, we finish our articles with a warning, saying that the situation on the virus front goes from bad to worse. This time, however, we can turn our backs on tradition. In spite of the apparent difficulty, it is not difficult to write generic detection procedures to reveal Visual Basic worms, regardless of the code's type. Thus, in this case, we are able to say that the situation has gone from bad to better.
<br />

<br />

<br />
<span style="font-weight: bold">Date:</span> January 2002
<br />
<span style="font-weight: bold">Source:</span> <a href="http://www.virusbtn.com/">Virus Bulletin</a> </span>
						<span class="gensmall"></span>
					</td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td class="row1" width="150" align="left" valign="middle"><span class="nav"><a href="#top" class="nav">Back to top</a></span></td>
		<td class="row1" width="100%" height="28" valign="bottom" nowrap="nowrap"></td>
	</tr>
	<tr>
		<td class="spaceRow" colspan="2" height="1"><img src="templates/subSilver/images/spacer.gif" alt="" width="1" height="1" /></td>
		<td></td>
	</tr>
	<tr align="center">
		<td class="catBottom" colspan="2" height="28"></td>
		<td></td>
	</tr>
</table>

<table width="100%" cellspacing="2" cellpadding="2" border="0" align="center">
  <tr>
	<td></td>
	<td align="left" valign="middle" width="100%"><span class="nav">&nbsp;&nbsp;&nbsp;<a href="index-2.html" class="nav">VB Decompiler Forum Index</a>
	  -> <a href="viewforum8941.html" xx="f=22" class="nav">Articles</a></span></td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">All times are GMT</span><br /><span class="nav"></span>
	  </td>
  </tr>
  <tr>
	<td align="left" colspan="3"><span class="nav">Page <b>1</b> of <b>1</b></span></td>
  </tr>
</table>

<table width="100%" cellspacing="2" border="0" align="center">
  <tr>
	<td width="40%" valign="top" nowrap="nowrap" align="left"><span class="gensmall"></span><br />
	  &nbsp;<br />
	  </td>
	<td align="right" valign="top" nowrap="nowrap"><span class="gensmall">You <b>can</b> post new topics in this forum<br />You <b>can</b> reply to topics in this forum<br />You <b>can</b> edit your posts in this forum<br />You <b>can</b> delete your posts in this forum<br />You <b>can</b> vote in polls in this forum<br /></span></td>
  </tr>
</table>


<div align="center"><span class="copyright"><br /><br />
<!--
	We request you retain the full copyright notice below including the link to www.phpbb.com.
	This not only gives respect to the large amount of time given freely by the developers
	but also helps build interest, traffic and use of phpBB 2.0. If you cannot (for good
	reason) retain the full copyright we request you at least leave in place the
	Powered by phpBB line, with phpBB linked to www.phpbb.com. If you refuse
	to include even this then support on our forums may be affected.

	The phpBB Group : 2002
// -->
Powered by <a href="http://www.phpbb.com/" target="_phpbb" class="copyright">phpBB</a> &copy; 2001, 2005 phpBB Group<br /></span></div>
		</td>
	</tr>
</table>

</body>

<!-- Mirrored from localhost/phpbb2/viewtopic.php?t=1821&start=0&postdays=0&postorder=asc&highlight= by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 04 Mar 2018 20:55:27 GMT -->
</html>

